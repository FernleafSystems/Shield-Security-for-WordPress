name: Tests

on:
  push:
    branches: [ develop, main, master, docker-matrix-testing-research ]
  pull_request:
    branches: [ develop, main, master, docker-matrix-testing-research ]
  workflow_dispatch:

jobs:
  source-static-analysis:
    name: 'Source Static Analysis'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.4'
        coverage: none
        tools: composer:v2

    - name: Install dependencies
      run: composer install --no-interaction --prefer-dist --optimize-autoloader

    - name: Build plugin config
      run: composer build:config

    - name: Run source static analysis
      run: composer analyze:source

  source-docker-runtime:
    name: 'Source Docker Runtime'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.4'
        coverage: none
        tools: composer:v2

    - name: Install dependencies
      run: composer install --no-interaction --prefer-dist --optimize-autoloader

    - name: Run source docker runtime checks
      run: bash ./bin/run-docker-tests.sh --source

  build-package:
    name: 'Build Package'
    uses: ./.github/workflows/reusable-build-package.yml
    with:
      artifact_name: shield-package
      package_dir: shield-package

  package-targeted-validation:
    name: 'Package Targeted Validation'
    runs-on: ubuntu-latest
    needs: build-package

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.4'
        coverage: none
        tools: composer:v2

    - name: Install dependencies
      run: composer install --no-interaction --prefer-dist --optimize-autoloader

    - name: Load Strauss version
      run: |
        source .github/scripts/read-packager-config.sh
        echo "SHIELD_STRAUSS_VERSION=${SHIELD_STRAUSS_VERSION}" >> $GITHUB_ENV
        echo "SHIELD_STRAUSS_FORK_REPO=${SHIELD_STRAUSS_FORK_REPO:-}" >> $GITHUB_ENV

    - name: Download package artifact
      uses: actions/download-artifact@v4
      with:
        name: shield-package
        path: ${{ github.workspace }}/shield-package

    - name: Validate downloaded package
      run: |
        PACKAGE_DIR="${{ github.workspace }}/shield-package"
        test -d "$PACKAGE_DIR"
        test -f "$PACKAGE_DIR/icwp-wpsf.php"
        test -f "$PACKAGE_DIR/vendor/autoload.php"
        test -d "$PACKAGE_DIR/vendor_prefixed"
        echo "Downloaded package validation passed"

    - name: Run package-targeted unit validation
      env:
        SHIELD_PACKAGE_PATH: ${{ github.workspace }}/shield-package
      run: |
        php ./vendor/phpunit/phpunit/phpunit \
          --no-configuration --no-coverage --fail-on-skipped \
          tests/Unit/PluginPackageValidationTest.php

    - name: Run package-targeted Strauss integration validation
      env:
        SHIELD_PACKAGE_PATH: ${{ github.workspace }}/shield-package
        SHIELD_STRAUSS_VERSION: ${{ env.SHIELD_STRAUSS_VERSION }}
      run: |
        php ./vendor/phpunit/phpunit/phpunit \
          --no-configuration --no-coverage --fail-on-skipped \
          --group package-targeted \
          tests/Integration/Infrastructure/PluginPackagerStraussTest.php
