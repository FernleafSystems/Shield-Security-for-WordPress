<?php declare( strict_types=1 );

namespace FernleafSystems\Wordpress\Plugin\Shield\Tests\Integration\DBs;

use FernleafSystems\Wordpress\Plugin\Shield\Controller\Database\CleanMalwareDB;
use FernleafSystems\Wordpress\Plugin\Shield\Tests\Helpers\TestDataFactory;
use FernleafSystems\Wordpress\Plugin\Shield\Tests\Integration\ShieldIntegrationTestCase;

class CleanMalwareDBTest extends ShieldIntegrationTestCase {

	public function test_deletes_records_where_file_no_longer_exists() {
		$dbh = $this->requireDb( 'malware' );

		$id = TestDataFactory::insertMalwareRecord( 'does/not/exist/fake-malware.php' );
		$this->assertGreaterThan( 0, $id, 'Malware record should be inserted' );
		$this->assertNotEmpty( $dbh->getQuerySelector()->byId( $id ), 'Record should exist before cleanup' );

		( new CleanMalwareDB() )->run();

		$this->assertEmpty( $dbh->getQuerySelector()->byId( $id ), 'Record should be deleted when file is missing' );
	}

	public function test_preserves_records_where_file_still_exists() {
		$dbh = $this->requireDb( 'malware' );

		// wp-settings.php is always present in a WordPress installation
		$id = TestDataFactory::insertMalwareRecord( 'wp-settings.php' );
		$this->assertGreaterThan( 0, $id, 'Malware record should be inserted' );

		( new CleanMalwareDB() )->run();

		$this->assertNotEmpty( $dbh->getQuerySelector()->byId( $id ), 'Record should be preserved when file exists' );
	}

	public function test_handles_empty_table_gracefully() {
		$this->requireDb( 'malware' );

		// Should not throw any errors on an empty table
		( new CleanMalwareDB() )->run();
		$this->assertTrue( true, 'CleanMalwareDB should handle empty table without errors' );
	}

	public function test_mixed_records_only_deletes_missing_files() {
		$dbh = $this->requireDb( 'malware' );

		$missingId1 = TestDataFactory::insertMalwareRecord( 'nonexistent/path1.php', 'content-a' );
		$missingId2 = TestDataFactory::insertMalwareRecord( 'nonexistent/path2.php', 'content-b' );
		$existsId = TestDataFactory::insertMalwareRecord( 'wp-settings.php', 'content-c' );

		( new CleanMalwareDB() )->run();

		$this->assertEmpty( $dbh->getQuerySelector()->byId( $missingId1 ), 'Missing file record 1 should be deleted' );
		$this->assertEmpty( $dbh->getQuerySelector()->byId( $missingId2 ), 'Missing file record 2 should be deleted' );
		$this->assertNotEmpty( $dbh->getQuerySelector()->byId( $existsId ), 'Existing file record should be preserved' );
	}
}
