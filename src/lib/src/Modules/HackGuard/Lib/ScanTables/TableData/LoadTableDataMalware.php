<?php declare( strict_types=1 );

namespace FernleafSystems\Wordpress\Plugin\Shield\Modules\HackGuard\Lib\ScanTables\TableData;

use FernleafSystems\Wordpress\Plugin\Shield\Modules\HackGuard\DB\Malware\Ops\Record;
use FernleafSystems\Wordpress\Plugin\Shield\Modules\HackGuard\Scan\Results\Retrieve\RetrieveItems;
use FernleafSystems\Wordpress\Plugin\Shield\Scans;
use FernleafSystems\Wordpress\Plugin\Shield\Scans\Afs\Processing\MalwareStatus;
use FernleafSystems\Wordpress\Services\Services;

class LoadTableDataMalware extends BaseLoadTableData {

	public function run() :array {
		$RS = $this->getRecordRetriever()->retrieveForResultsTables();
		$malwareItems = $RS->getMalware()->getItems();

		/**
		 * Bulk update the malai statuses
		 */
		$malRecords = array_map( function ( $item ) {
			/** @var Scans\Afs\ResultItem $item */
			return $item->getMalwareRecord();
		}, $malwareItems );
		if ( !empty( $malRecords ) ) {
			( new Scans\Afs\Processing\RetrieveMalwareMalaiStatus() )->updateRecords( $malRecords );
		}

		try {
			$files = array_map(
				function ( $item ) {
					/** @var Scans\Afs\ResultItem $item */
					$data = $item->getRawData();

					$data[ 'rid' ] = $item->VO->scanresult_id;
					$data[ 'file' ] = $item->path_fragment;
					$data[ 'created_at' ] = $item->VO->created_at;
					$data[ 'detected_since' ] = Services::Request()
														->carbon( true )
														->setTimestamp( $item->VO->created_at )
														->diffForHumans();

					$data[ 'file_as_href' ] = $this->getColumnContent_File( $item );

					$data[ 'status_slug' ] = 'malware';
					$data[ 'status' ] = $this->getColumnContent_FileStatus( $item, __( 'Malware', 'wp-simple-firewall' ) );

					$data[ 'file_type' ] = strtoupper( Services::Data()->getExtension( $item->path_full ) );
					$data[ 'actions' ] = implode( ' ', $this->getActions( $data[ 'status_slug' ], $item ) );

					$malRecord = $item->getMalwareRecord();
					if ( !empty( $malRecord ) ) {
						$data[ 'mal_sig' ] = sprintf( '<code style="white-space: nowrap">%s</code>', esc_html( $malRecord->sig ) );
						$data[ 'mal_details' ] = $this->getColumnContent_MalwareDetailsForRecord(
							$malRecord,
							$data[ 'mal_sig' ]
						);
					}
					else {
						$data[ 'mal_sig' ] = sprintf( '<code style="white-space: nowrap">%s</code>', esc_html( $item->mal_sig ) );
						/** @deprecated 17.1 */
						$data[ 'mal_details' ] = $this->getColumnContent_MalwareDetails(
							(int)$item->mal_fp_confidence,
							$data[ 'mal_sig' ]
						);
					}

					return $data;
				},
				$malwareItems
			);
		}
		catch ( \Exception $e ) {
			$files = [];
		}

		return $files;
	}

	protected function getColumnContent_MalwareDetailsForRecord( Record $record, string $sig ) :string {
		return sprintf( '<ul style="list-style: square inside"><li>%s</li></ul>',
			implode( '</li><li>', [
				sprintf( '%s: <span class="badge text-bg-%s">%s</span>',
					__( 'mal{ai} Malware Status' ),
					$record->malai_status === MalwareStatus::STATUS_MALWARE ? 'danger' : 'warning',
					( new MalwareStatus() )->nameFromStatusLabel( $record->malai_status )
				),
				sprintf( '%s: %s', __( 'Pattern Detected' ), $sig ),
			] )
		);
	}

	protected function getColumnContent_MalwareDetails( int $confidence, string $sig ) :string {
		return sprintf( '<ul style="list-style: square inside"><li>%s</li></ul>',
			implode( '</li><li>', [
				sprintf( '%s: %s', __( 'False Positive Confidence' ), $confidence ),
				sprintf( '%s: %s', __( 'Pattern Detected' ), $sig ),
			] )
		);
	}

	protected function getRecordRetriever() :RetrieveItems {
		$ret = parent::getRecordRetriever();
		return $ret->addWheres( [
			sprintf( "%s.`meta_key`='is_mal'", $ret::ABBR_RESULTITEMMETA ),
			sprintf( "%s.`meta_value`=1", $ret::ABBR_RESULTITEMMETA ),
		] );
	}
}